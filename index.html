<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è»Šã„ã™InOutåˆ¤å®šï¼†è¨ˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5; min-height: 100vh; padding: 20px;
            display: flex; justify-content: center; align-items: center;
        }
        .container {
            background: white; border-radius: 20px; padding: 30px;
            max-width: 900px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .screen { display: none; }
        .active { display: block; }
        h1 { color: #1a73e8; margin-bottom: 15px; text-align: center; font-size: 24px; }
        
        .viewer {
            background: #eef0f2; border-radius: 12px; margin-bottom: 20px;
            height: 400px; display: flex; justify-content: center; align-items: center;
            position: relative; overflow: hidden; border: 1px solid #ddd;
        }
        .viewer img, .viewer video { max-width: 100%; max-height: 100%; object-fit: contain; }

        .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        button {
            padding: 15px 30px; border: none; border-radius: 10px;
            font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .btn-in { background: #34a853; color: white; }
        .btn-out { background: #ea4335; color: white; }
        .btn-next { background: #1a73e8; color: white; }
        .btn-back { background: #6c757d; color: white; } /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ç”¨ã®è‰² */
        
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        #feedback-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); color: white;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; z-index: 10;
        }
        .correct { color: #34a853; font-size: 60px; font-weight: bold; }
        .wrong { color: #ea4335; font-size: 60px; font-weight: bold; }

        .status-bar {
            background: #e8f0fe; padding: 15px; border-radius: 12px;
            margin-top: 20px; border-left: 6px solid #1a73e8;
        }
        .status-val { font-size: 24px; font-weight: bold; color: #ea4335; }
        .pressing { background: #ea4335 !important; }

        .info-box {
            background: #fff4f4; padding: 15px; border-radius: 10px; 
            margin-bottom: 20px; border: 1px solid #fad2d2;
        }
        .how-to-box {
            background: #f8f9fa; padding: 20px; border-radius: 12px;
            border: 2px dashed #1a73e8; margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="screen-intro" class="screen active">
        <h1>ğŸƒ åˆ¤å®šåŸºæº–ã®ç¢ºèª</h1>
        <div class="info-box">
            <p style="font-size: 15px; line-height: 1.6;">
                <strong>ã€é‡è¦ã€‘ã‚³ãƒ¼ã‚¹å¤–ï¼ˆOUTï¼‰ã®åˆ¤å®šæ¡ä»¶ï¼š</strong><br>
                è»Šã„ã™ã®ãƒ›ã‚¤ãƒ¼ãƒ«ãŒã‚³ãƒ¼ã‚¹ã®ãƒ©ã‚¤ãƒ³ä¸Šã«ã‚ã‚‹å ´åˆã€ãƒ©ã‚¤ãƒ³ã‹ã‚‰<strong>ã¯ã¿å‡ºã—ã¦ã„ãŸã‚‰</strong>OUTã¨åˆ¤å®šã—ã¦ãã ã•ã„ã€‚<br>
                ãƒ©ã‚¤ãƒ³ä¸Šã«ã‚ã£ã¦ã‚‚<strong>ã¯ã¿å‡ºã—ã¦ã„ãªã„</strong>å ´åˆã¯INã¨åˆ¤å®šã—ã¦ãã ã•ã„ã€‚
            </p>
        </div>
        <div class="viewer">
            <img src="images/rule.jpg" alt="åˆ¤å®šåŸºæº–ã‚¤ãƒ©ã‚¹ãƒˆ">
        </div>
        <div class="btn-group">
            <button class="btn-next" onclick="startTraining()">åˆ¤å®šåŸºæº–ã®ç¢ºèªã‚’é–‹å§‹</button>
        </div>
    </div>

    <div id="screen-training" class="screen">
        <h1 id="train-counter">ç”»åƒ 1 / 10</h1>
        <div class="viewer">
            <img id="train-img" src="">
            <div id="feedback-overlay">
                <div id="feedback-icon"></div>
                <p id="feedback-desc" style="margin: 20px 0; font-size: 18px;"></p>
                <button class="btn-next" onclick="nextQuestion()">æ¬¡ã®ç”»åƒã¸</button>
            </div>
        </div>
        <div class="btn-group" id="train-btns">
            <button class="btn-back" id="btn-back-id" onclick="prevQuestion()" style="display:none;">â† æˆ»ã‚‹</button>
            <button class="btn-in" id="btn-in-id" onclick="answer(true)">ã‚³ãƒ¼ã‚¹å†… (IN)</button>
            <button class="btn-out" id="btn-out-id" onclick="answer(false)">ã‚³ãƒ¼ã‚¹å¤– (OUT)</button>
        </div>
    </div>

    <div id="screen-how-to" class="screen">
        <h1>ğŸ¬ å‹•ç”»è¨ˆæ¸¬ã®æ“ä½œæ–¹æ³•</h1>
        <div class="how-to-box">
            <p style="font-size: 16px; line-height: 1.6; color: #333;">
                <strong>æ“ä½œæ–¹æ³•ï¼š</strong><br>
                ãƒ›ã‚¤ãƒ¼ãƒ«ãŒ<strong>ã€Œã‚³ãƒ¼ã‚¹å¤–(OUT)ã€</strong>ã«ã¯ã¿å‡ºã—ã¦ã„ã‚‹é–“ã ã‘ã€<br>
                ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®<span style="background:#1a73e8; color:white; padding:2px 8px; border-radius:4px; font-weight:bold;">SPACEã‚­ãƒ¼ã‚’æŠ¼ã—ç¶šã‘ã¦</span>ãã ã•ã„ã€‚
            </p>
        </div>
        <div class="viewer" style="height: 125px;">
            <img src="images/rule.jpg" alt="åˆ¤å®šåŸºæº–ã‚¤ãƒ©ã‚¹ãƒˆï¼ˆå†æ²ï¼‰">
        </div>
        <div class="btn-group">
            <button class="btn-back" onclick="show('screen-training')">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«æˆ»ã‚‹</button>
            <button class="btn-next" onclick="startMainVideo()">å‹•ç”»è¨ˆæ¸¬ã¸é€²ã‚€</button>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <h1>ğŸ¬ æœ¬ç•ªè¨ˆæ¸¬: å‹•ç”» <span id="v-num">1</span> / 3</h1>
        <div class="viewer">
            <video id="videoPlayer"></video>
        </div>
        <div class="btn-group">
            <button class="btn-next" id="startBtn">å‹•ç”»å†ç”Ÿãƒ»è¨ˆæ¸¬é–‹å§‹</button>
            <button class="btn-in" id="videoNextBtn" style="display:none;">æ¬¡ã®å‹•ç”»ã¸</button>
        </div>
        <div class="status-bar">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span>ç¾åœ¨ã®ã‚³ãƒ¼ã‚¹å¤–æ™‚é–“(åˆè¨ˆ):</span>
                <span id="totalTime" class="status-val">0.00ç§’</span>
            </div>
            <div id="keyIndicator" style="text-align:center; margin-top:10px; background:#1a73e8; color:white; border-radius:5px; padding:5px;">
                SPACEã‚­ãƒ¼æŠ¼ä¸‹ä¸­ï¼šOUTã¨ã—ã¦è¨˜éŒ²
            </div>
        </div>
    </div>

    <div id="screen-finish" class="screen">
        <h1>âœ… è¨ˆæ¸¬å®Œäº†</h1>
        <div class="status-bar" style="text-align:center; margin-bottom:20px;">
            ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ­£è§£æ•°: <span id="final-score" style="color:#1a73e8;">0</span> / 10
        </div>
        <p>åˆ¤å®šè€…åã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ï¼š</p>
        <input type="text" id="userName" placeholder="ä¾‹ï¼šå¹³æ—å¤§" style="width:100%; padding:15px; margin:15px 0; border:2px solid #1a73e8; border-radius:10px; font-size: 16px;">
        <button class="btn-next" id="submitBtn" style="width:100%;">çµæœã‚’é€ä¿¡</button>
        <p id="status-msg" style="text-align:center; margin-top:20px; font-weight:bold;"></p>
    </div>
</div>

<script>
    const IMG_PATH = 'images/';
    const FORMSPREE_URL = 'https://formspree.io/f/mqeezzqb';

    const trainData = [
            { img: '1.jpg', isInside: false, desc: 'å³ãƒ›ã‚¤ãƒ¼ãƒ«ãŒå¤–å´ã§ã™' },
            { img: '2.jpg', isInside: false, desc: 'å³ãƒ›ã‚¤ãƒ¼ãƒ«ãŒå¤–å´ã§ã™' },
            { img: '3.jpg', isInside: true, desc: 'å†…å´ã§ã™' },
            { img: '4.jpg', isInside: false, desc: 'å³ãƒ›ã‚¤ãƒ¼ãƒ«ãŒå¤–å´ã§ã™' },
            { img: '5.jpg', isInside: true, desc: 'å†…å´ã§ã™' },
            { img: '6.jpg', isInside: false, desc: 'å³ãƒ›ã‚¤ãƒ¼ãƒ«ãŒå¤–å´ã§ã™' },
            { img: '7.jpg', isInside: true, desc: 'å³ãƒ›ã‚¤ãƒ¼ãƒ«ã¯ãƒ©ã‚¤ãƒ³ä¸Šã§ã™ãŒã€ã¯ã¿å‡ºã—ã¦ã„ã¾ã›ã‚“' },
            { img: '8.jpg', isInside: true, desc: 'å†…å´ã§ã™' },
            { img: '9.jpg', isInside: true, desc: 'å³ãƒ›ã‚¤ãƒ¼ãƒ«ã¯ãƒ©ã‚¤ãƒ³ä¸Šã§ã™ãŒã€ã¯ã¿å‡ºã—ã¦ã„ã¾ã›ã‚“' },
            { img: '10.jpg', isInside: true, desc: 'å³ãƒ›ã‚¤ãƒ¼ãƒ«ã¯ãƒ©ã‚¤ãƒ³ä¸Šã§ã™ãŒã€ã¯ã¿å‡ºã—ã¦ã„ã¾ã›ã‚“' }
    ];
    const videoFiles = ['version1.mp4', 'version2.mp4', 'version3.mp4'];

    let qIdx = 0; 
    let scoreHistory = []; // ã‚¹ã‚³ã‚¢å±¥æ­´ã‚’ç®¡ç†
    let vIdx = 0;
    let isTracking = false; let isKeyDown = false;
    let pressStart = 0; let vPressSum = 0;
    let segments = []; let videoStartTime = 0; let finalData = [];
    let isFeedbackShowing = false;

    function show(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function startTraining() { 
        qIdx = 0; 
        scoreHistory = []; 
        show('screen-training'); 
        loadQ(); 
    }
    
    function loadQ() {
        isFeedbackShowing = false;
        document.getElementById('train-counter').textContent = `ç”»åƒ ${qIdx + 1} / 10`;
        document.getElementById('train-img').src = IMG_PATH + trainData[qIdx].img;
        document.getElementById('feedback-overlay').style.display = 'none';
        
        // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã®æ›´æ–°
        document.getElementById('btn-in-id').disabled = false;
        document.getElementById('btn-out-id').disabled = false;
        document.getElementById('train-btns').style.visibility = 'visible';
        
        // 1æšç›®ä»¥å¤–ãªã‚‰ã€Œæˆ»ã‚‹ã€ã‚’è¡¨ç¤º
        document.getElementById('btn-back-id').style.display = 'inline-block';
    }

    function answer(userIn) {
        if(isFeedbackShowing) return;
        isFeedbackShowing = true;

        const correct = (userIn === trainData[qIdx].isInside);
        scoreHistory[qIdx] = correct ? 1 : 0; // ä»Šå›ã®æ­£èª¤ã‚’ä¿å­˜

        document.getElementById('train-btns').style.visibility = 'hidden';
        const overlay = document.getElementById('feedback-overlay');
        const icon = document.getElementById('feedback-icon');
        icon.className = correct ? 'correct' : 'wrong';
        icon.textContent = correct ? 'â—‹ æ­£è§£' : 'Ã— ä¸æ­£è§£';
        document.getElementById('feedback-desc').textContent = trainData[qIdx].desc;
        overlay.style.display = 'flex';
    }

    function nextQuestion() {
        qIdx++; 
        if(qIdx < 10) loadQ(); 
        else show('screen-how-to');
    }

    function prevQuestion() {
        if(qIdx > 0) {
            qIdx--;
            loadQ();
        }else{
            show('screen-intro');
        }
    }

    function startMainVideo() {
        show('screen-main'); 
        prepVideo();
    }

    const player = document.getElementById('videoPlayer');
    function prepVideo() {
        player.src = videoFiles[vIdx];
        document.getElementById('v-num').textContent = vIdx + 1;
        document.getElementById('totalTime').textContent = '0.00ç§’';
        document.getElementById('videoNextBtn').style.display = 'none';
        document.getElementById('startBtn').style.display = 'inline-block';
        vPressSum = 0; segments = [];
    }

    document.getElementById('startBtn').onclick = () => {
        isTracking = true; videoStartTime = Date.now();
        player.play(); document.getElementById('startBtn').style.display = 'none';
    };

    let adminLongPressTimer;
    window.onkeydown = (e) => {
        const introActive = document.getElementById('screen-intro').classList.contains('active');
        const trainingActive = document.getElementById('screen-training').classList.contains('active');

        if (e.code === 'Space' && (introActive || trainingActive)) {
            if (!adminLongPressTimer) {
                adminLongPressTimer = setTimeout(() => {
                    scoreHistory = Array(10).fill(1); // æº€ç‚¹æ‰±ã„
                    show('screen-how-to');
                }, 1000);
            }
        }
        if(e.code === 'Space' && isTracking && !isKeyDown) {
            e.preventDefault(); isKeyDown = true; pressStart = Date.now();
            document.getElementById('keyIndicator').classList.add('pressing');
        }
    };

    window.onkeyup = (e) => {
        clearTimeout(adminLongPressTimer); adminLongPressTimer = null;
        if(e.code === 'Space' && isTracking && isKeyDown) {
            isKeyDown = false; const now = Date.now(); const dur = (now - pressStart) / 1000;
            vPressSum += dur;
            segments.push({
                start: ((pressStart - videoStartTime) / 1000).toFixed(2),
                end: ((now - videoStartTime) / 1000).toFixed(2),
                dur: dur.toFixed(2)
            });
            document.getElementById('keyIndicator').classList.remove('pressing');
        }
    };

    player.onended = () => { isTracking = false; document.getElementById('videoNextBtn').style.display = 'inline-block'; };
    document.getElementById('videoNextBtn').onclick = () => {
        finalData.push({ name: videoFiles[vIdx], sum: vPressSum.toFixed(2), segs: [...segments] });
        vIdx++; if(vIdx < videoFiles.length) prepVideo(); else {
            const totalScore = scoreHistory.reduce((a, b) => a + b, 0);
            document.getElementById('final-score').textContent = totalScore; show('screen-finish');
        }
    };

    document.getElementById('submitBtn').onclick = async () => {
        const user = document.getElementById('userName').value || "Anonymous";
        const totalScore = scoreHistory.reduce((a, b) => a + b, 0);
        let csv = "Name,TrainScore,Video,Segment#,Start,End,Duration\n";
        finalData.forEach(v => {
            if(v.segs.length === 0) csv += `${user},${totalScore},${v.name},0,N/A,N/A,0\n`;
            v.segs.forEach((s, i) => { csv += `${user},${totalScore},${v.name},${i+1},${s.start},${s.end},${s.dur}\n`; });
        });
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('status-msg').textContent = "é€ä¿¡ä¸­...";
        try {
            const res = await fetch(FORMSPREE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ name: user, trainScore: totalScore + "/10", data: csv })
            });
            if(res.ok) { document.getElementById('status-msg').style.color = "#34a853"; document.getElementById('status-msg').textContent = "âœ“ é€ä¿¡å®Œäº†ï¼"; }
            else throw new Error();
        } catch(e) { document.getElementById('status-msg').style.color = "#ea4335"; document.getElementById('status-msg').textContent = "é€ä¿¡å¤±æ•—"; document.getElementById('submitBtn').disabled = false; }
    };

    setInterval(() => { if(isTracking && isKeyDown) {
        const d = (Date.now() - pressStart) / 1000;
        document.getElementById('totalTime').textContent = (vPressSum + d).toFixed(2) + "ç§’";
    }}, 50);
</script>

</body>
</html>

